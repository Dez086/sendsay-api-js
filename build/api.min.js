var extend=function(e,t){function r(){this.constructor=e}for(var s in t)hasProp.call(t,s)&&(e[s]=t[s]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty;!function(e,t){return e.define&&"function"==typeof e.define&&e.define.amd?define(["sendsay.event-dispatcher","jquery"],function(r,s){return t(e,{},r,s)}):e.API=t(e,{},EventDispatcher,$)}(this,function(e,t,r,s){return t=function(e){function t(e){null==e&&(e={}),t.__super__.constructor.apply(this,arguments),e.url&&(this._url=e.url),e.session&&(this._session=e.session),e.redirect&&(this._redirect=e.redirect)}var r,n,i,o;return extend(t,e),r=["ping","login","login.agses.challenge"],o=10,i=10,n=100,t.prototype._url="https://api.sendsay.ru",t.prototype._session="",t.prototype._redirect="",t.prototype._mixins=null,t.prototype.setRedirect=function(e){return this._redirect=e},t.prototype.setSession=function(e){return this._session=e},t.prototype.setURL=function(e){return this._url=e},t.prototype.mixin=function(e,t){var r;return r=this._mixins||(this._mixins={}),r[e]=t},t.prototype.call=function(e,t){return null==t&&(t={}),this.hasMixin(e.action)?this._mixins[e.action](e,t):s.ajax(this.getAJAXSettings(e,t)).always(function(r,s){switch(s){case"success":return this.handleAJAXRequestSuccess(r,e,t);case"error":return this.handleAJAXRequestError(r,e,t);case"canceled":return this.handleAJAXRequestCancel(r,e,t)}})},t.prototype.hasMixin=function(e){var t;return t=this._mixins||(this._mixins={}),t[e]},t.prototype.getAJAXSettings=function(e,t){return{url:this._url+this._redirect,data:this.getAJAXData(e,t),context:this,dataType:"jsonp",jsonp:"jsonp",beforeSend:function(r){return this.handleAJAXRequestStart(r,e,t)},complete:function(t,r){return this.handleAJAXRequestComplete(t,e,r)}}},t.prototype.getAJAXData=function(e,t){return{apiversion:n,json:1,request:this.getAJAXRequestString(e,t),"request.id":(new Date).getTime()}},t.prototype.getAJAXRequestString=function(e){return this._session&&-1===r.indexOf(e.action)&&!e.one_time_auth&&(e.session=this._session),JSON.stringify(e)},t.prototype.handleAJAXRequestStart=function(e,t,r){return r.silent?void 0:this.trigger("ajax:start",{xhr:e,request:t,options:r})},t.prototype.handleAJAXRequestSuccess=function(e,t,r){return r.silent||this.trigger("ajax:success",{response:e,request:t,options:r}),e.REDIRECT?this.handleRequestRedirect(e,t,r):this.responseHasError(e,t)?this.handleRequestErrors(e,t,r):this.handleRequestSuccess(e,t,r)},t.prototype.handleRequestRedirect=function(e,t,r){var s;return r.silent||this.trigger("api:redirect",{response:e,request:t,options:r}),r.redirected=null!=(s=void 0===r.redirected)?s:{1:++r.redirected},r.redirected!==o?(this._redirect=e.REDIRECT,this.call(t,r)):void 0},t.prototype.responseHasError=function(e,t){var r,s,n,i,o;if(e.errors)return!0;if(e.result&&"batch"===t.action){for(o=!1,i=e.result,r=0,n=i.length;n>r;r++)s=i[r],o|=this.responseHasError(s);return o}},t.prototype.handleRequestErrors=function(e,t,r){return r.silent||this.trigger("api:error",{response:e,request:t,options:r}),r.error?r.error.call(r.context||this,e,t,r):void 0},t.prototype.handleRequestSuccess=function(e,t,r){return r.silent||this.trigger("api:success",{response:e,request:t,options:r}),"login"===t.action&&(this._session=e.session),r.success?r.success.call(r.context||this,e,t,r):void 0},t.prototype.handleAJAXRequestError=function(e,t,r){return r.silent||this.trigger("ajax:error",{xhr:e,request:t,options:r}),void 0===r.failed?r.failed=1:r.failed+=1,r.failed!==i?this.call(t,r):void 0},t.prototype.handleAJAXRequestCancel=function(e,t,r){return r.silent?void 0:this.trigger("ajax:cancel",{xhr:e,request:t,options:r})},t.prototype.handleAJAXRequestComplete=function(e,t,r){return r.silent?void 0:this.trigger("ajax:complete",{xhr:e,request:t,options:r})},t}(r)});