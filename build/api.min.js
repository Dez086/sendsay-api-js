var extend=function(e,t){function r(){this.constructor=e}for(var n in t)hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty;!function(e,t){return e.define&&e.define instanceof"function"&&e.define.amd?define(["sendsay.event-dispatcher","jquery"],function(r,n){return t(e,{},r,n)}):e.API=t(e,{},EventDispatcher,$)}(this,function(e,t,r,n){return new(t=function(e){function t(e){return null==e&&(e={}),u?u:(u=this,t.__super__.constructor.apply(this,arguments),e.url&&(p=e.url),e.session&&(c=e.session),void(e.redirect&&(a=e.redirect)))}var r,s,o,i,u,a,c,p;return extend(t,e),r=["ping","login","login.agses.challenge"],i=10,o=10,s=100,p="https://api.sendsay.ru",c="",a="",u=null,t.prototype.setSession=function(e){return c=e},t.prototype.setURL=function(e){return p=e},t.prototype.call=function(e,t){return null==t&&(t={}),n.ajax(this.getAJAXSettings(e,t)).always(function(r,n){switch(n){case"success":return this.handleAJAXRequestSuccess(r,e,t);case"error":return this.handleAJAXRequestError(r,e,t);case"canceled":return this.handleAJAXRequestCancel(r,e,t)}})},t.prototype.getAJAXSettings=function(e,t){return{url:p+a,data:this.getAJAXData(e,t),context:this,dataType:"jsonp",jsonp:"jsonp",beforeSend:function(r){return this.handleAJAXRequestStart(r,e,t)},complete:function(t,r){return this.handleAJAXRequestComplete(t,e,r)}}},t.prototype.getAJAXData=function(e,t){return{apiversion:s,json:1,request:this.getAJAXRequestString(e,t),"request.id":(new Date).getTime()}},t.prototype.getAJAXRequestString=function(e){return c&&r.indexOf(-1===e.action)&&(e.session=c),JSON.stringify(e)},t.prototype.handleAJAXRequestStart=function(e,t,r){return r.silent?void 0:this.trigger("ajax:start",{xhr:e,request:t,options:r})},t.prototype.handleAJAXRequestSuccess=function(e,t,r){return r.silent||this.trigger("ajax:success",{response:e,request:t,options:r}),e.REDIRECT?this.handleRequestRedirect(e,t,r):this.responseHasError(e,t)?this.handleRequestErrors(e,t,r):this.handleRequestSuccess(e,t,r)},t.prototype.handleRequestRedirect=function(e,t,r){var n;return r.silent||this.trigger("api:redirect",{response:e,request:t,options:r}),r.redirected=null!=(n=void 0===r.redirected)?n:{1:++r.redirected},r.redirected!==o?(a=e.REDIRECT,this.call(t,r)):void 0},t.prototype.responseHasError=function(e,t){var r,n,s,o,i;if(e.errors)return!0;if(e.result&&"batch"===t.action){for(i=!1,o=e.result,r=0,s=o.length;s>r;r++)n=o[r],i|=this.responseHasError(n);return i}},t.prototype.handleRequestErrors=function(e,t,r){return r.silent||this.trigger("api:error",{response:e,request:t,options:r}),r.error?r.error.call(r.context||this,e,t,r):void 0},t.prototype.handleRequestSuccess=function(e,t,r){return r.silent||this.trigger("api:success",{response:e,request:t,options:r}),"login"===t.action&&(c=e.session),r.success?r.success.call(r.context||this,e,t,r):void 0},t.prototype.handleAJAXRequestError=function(e,t,r){var n;return r.silent||this.trigger("ajax:error",{xhr:e,request:t,options:r}),r.failed=null!=(n=void 0===r.failed)?n:{1:++r.failed},r.failed!==o?this.call(t,r):void 0},t.prototype.handleAJAXRequestCancel=function(e,t,r){return r.silent?void 0:this.trigger("ajax:cancel",{xhr:e,request:t,options:r})},t.prototype.handleAJAXRequestComplete=function(e,t,r){return r.silent?void 0:this.trigger("ajax:complete",{xhr:e,request:t,options:r})},t}(r))});