var extend=function(e,t){function r(){this.constructor=e}for(var n in t)hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};hasProp={}.hasOwnProperty,function(e,t){e.define&&"function"==typeof e.define&&e.define.amd?define(["jquery","sendsay.event-dispatcher"],function(r,n){return t(e,{},r,n)}):e.API=t(e,{},$,EventDispatcher)}(this,function(e,t,r,n){return t=function(e){function t(e){t.__super__.constructor.apply(this,arguments),e=e||{},this._requestNumber=(new Date).getTime(),this._requestIdPrefix=e.requestIdPrefix||"APP_",this._url=e.url||"https://api.sendsay.ru",this._session=e.session}extend(t,e);var n=["ping","login","login.agses.challenge"],i=10,s=10,o=100;return t.prototype.call=function(e,t){var n=this,t=t||{},i=this._getAJAXSettings(e,t),s=r.ajax(i).pipe(function(r,i,s){return n._handleAJAXSuccess(r,e,t),r.errors?n._handleErrorCall(r,e,t):r.REDIRECT?n._handleRedirectCall(r,e,t):n._handleSuccessCall(r,e,t)},function(r,i){return"canceled"===i?n._handleAJAXCancel(r,e,t):"error"===i?n._handleAJAXError(r,e,t):void 0});return s},t.prototype._getAJAXSettings=function(e,t){var r=this,n=!t.silent;return{type:"POST",data:this._getAJAXData(e,t),url:this._url+(this._redirect||""),dataType:"json",global:n,beforeSend:function(n){r._handleAJAXStart(n,e,t)},complete:function(n){r._handleAJAXComplete(n,e,t)}}},t.prototype._getAJAXData=function(e,t){return{apiversion:o,json:1,request:this._getAJAXRequest(e,t),"request.id":this._getAJAXRequestId()}},t.prototype._getAJAXRequest=function(e,t){return-1===n.indexOf(e.action)&&void 0===e.one_time_auth&&(e.session=this._session),JSON.stringify(e)},t.prototype._getAJAXRequestId=function(){var e=this._requestIdPrefix,t=new Date;return this._session&&(e+=this._getLogin()+"_"),e+=this._requestNumber++ +"_",e+=new Date(t-6e4*t.getTimezoneOffset()).toISOString().slice(0,-5)},t.prototype._getLogin=function(){var e=this._session.match(/(.+?):/)[1];return e&&(e=e.slice((e.length/2).toFixed(0))),e.toUpperCase()||"UNKNOWN"},t.prototype._handleErrorCall=function(e,t,n){return this.trigger("api:error",{response:e,request:t,options:n}),n.resolveAPIErrors?r.Deferred().resolve(e,t,n).promise():r.Deferred().reject(e,t,n).promise()},t.prototype._handleRedirectCall=function(e,t,r){return this.trigger("api:redirect",{response:e,request:t,options:r}),r.redirected=void 0==r.redirected?1:++r.redirected,r.redirected<i?(this._redirect=e.REDIRECT,this.call(t,r)):void 0},t.prototype._handleSuccessCall=function(e,t,n){return this.trigger("api:success",{response:e,request:t,options:n}),r.Deferred().resolve(e,t,n).promise()},t.prototype._handleAJAXStart=function(e,t,r){this.trigger("ajax:start",{xhr:e,request:t,options:r})},t.prototype._handleAJAXSuccess=function(e,t,r){this.trigger("ajax:success",{response:e,request:t,options:r})},t.prototype._handleAJAXError=function(e,t,n){return this.trigger("ajax:error",{xhr:e,request:t,options:n}),n.failed=n.failed?++n.failed:1,n.failed<s?this.call(t,n):r.Deferred().reject(e,t,n).promise()},t.prototype._handleAJAXCancel=function(e,t,n){return this.trigger("ajax:cancel",{xhr:e,request:t,options:n}),r.Deferred().reject(e,t,n).promise()},t.prototype._handleAJAXComplete=function(e,t,r){this.trigger("ajax:complete",{xhr:e,request:t,options:r})},t}(n)});