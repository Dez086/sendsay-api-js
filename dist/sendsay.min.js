!function(){"use strict";var e=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},t="JS";function n(e){return(document.cookie.match("(^|; )"+e+"=([^;]*)")||0)[2]}var r=function(){function r(){var n=this,e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).url,t=void 0===e?"https://api.sendsay.ru":e;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.catchConnectionErrors=function(e){throw n.callErrorHandler(e),e},this.checkStatus=function(e){if(200<=e.status&&e.status<300)return e;var t=new RequestError(e.statusText);throw n.callErrorHandler(t),t},this.parseResponse=function(e){try{return e.json()}catch(e){var t=e;throw/JSON/.test(e)&&(t=new RequestError("fetch","invalid_json")),n.callErrorHandler(t),t}},this.checkRedirect=function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return{}.hasOwnProperty.call(t,"REDIRECT")&&r.redirected<10?(n.redirect=t.REDIRECT,n.request(e,a({},r,{redirected:r.redirected+1}))):t},this.requestNumber=(new Date).getTime(),this.url=t}return e(r,null,[{key:"getLocaleDateISOString",value:function(){var e=new Date,t=6e4*e.getTimezoneOffset();return new Date(e-t).toISOString()}}]),e(r,[{key:"setSession",value:function(e){this.session=e}},{key:"setPolicy",value:function(e){this.policy=e}},{key:"setSessionFromCookie",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"sendsay_session";this.setSession(n(e))}},{key:"setPolicyFromCookie",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"sendsay_policy";this.setPolicy(n(e))}},{key:"onError",value:function(e){this.errorHandler=e}},{key:"request",value:function(t){var r=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=a({redirected:0},e),o=this.getRequestBody(t),i={Accept:"application/json"};return o instanceof FormData||(i["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),fetch(""+this.url+(this.redirect||""),{method:"POST",body:o,headers:i}).catch(this.catchConnectionErrors).then(this.checkStatus).then(this.parseResponse).then(function(e){return r.checkResponseErrors(t,e,n)}).then(function(e){return r.checkRedirect(t,e,n)})}},{key:"checkResponseErrors",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if("errors"in t&&!r.ignoreErrors){var n=t.errors[0];throw n.request=e,this.callErrorHandler(n),n}if("batch"===e.action&&t.result&&t.result.some(function(e){return"errors"in e})){var o=t.result.find(function(e){return"errors"in e}).errors[0];throw o.request=e,this.callErrorHandler(o),o}return t}},{key:"callErrorHandler",value:function(e){"function"==typeof this.errorHandler&&this.errorHandler(e)}},{key:"getRequestBody",value:function(i){if(Object.keys(i).some(function(e){return e.match(/^EFS_/)})){var t=new FormData,s=[],e=Object.keys(i).reduce(function(e,t){return t.match(/^EFS_/)?(s.push(t),e):a({},e,(r={},o=i[n=t],n in r?Object.defineProperty(r,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[n]=o,r));var r,n,o},{});return t.append("apiversion",100),t.append("json",1),t.append("request.id",this.getRequestId()),t.append("request",this.getRequestData(e)),s.forEach(function(e){t.append(e,i[e])}),t}var r="apiversion=100&json=1";return r+="&request="+encodeURIComponent(this.getRequestData(i)),r+="&request.id="+encodeURIComponent(this.getRequestId())}},{key:"getRequestData",value:function(e){var t=a({},e);return this.session&&(t.session=this.session),this.policy&&(t["lbac.policy"]=this.policy),JSON.stringify(t)}},{key:"getRequestId",value:function(){return[t,this.getUsername().toUpperCase(),"undefined"!=typeof window&&window.location?window.location.pathname:null,this.requestNumber+1,r.getLocaleDateISOString()].filter(function(e){return e}).join("_")}},{key:"getUsername",value:function(){return this.session?/^(.+?):/.test(this.session)?RegExp.$1:"unknown":"unauthorized"}}]),r}(),o=[];if("Promise"in window||o.push("Promise"),"fetch"in window||o.push("fetch"),o.length){var i=document.createElement("script");i.src="https://cdn.polyfill.io/v2/polyfill.min.js?features="+o.join(","),document.head.appendChild(i)}window.Sendsay=r}();
